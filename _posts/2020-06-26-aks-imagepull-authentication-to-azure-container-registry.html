---
layout: post
title: AKS imagePull authentication to Azure Container Registry
date: 2020-06-26 16:28:06.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories: []
tags: []
meta:
  timeline_notification: '1593188888'
  _publicize_job_id: '45890023845'
author:
  login: bobmclarke915800472
  email: bob.mclarke@gmail.com
  display_name: Bob Clarke
  first_name: ''
  last_name: ''
permalink: "/2020/06/26/aks-imagepull-authentication-to-azure-container-registry/"
---
<p><!-- wp:paragraph --></p>
<p>A pod running in an AKS cluster and trying to pull an image from ACR needs Reader writes on that ACR.  The simplest way to do this is give the AKS cluster service principal Reader access on the ACR </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>First, get the ID of the AKS cluster service principal (note, when you create an AKS cluster an SP is automatically generated):</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">AKS_SP_ID=$(az aks show --resource-group &lt;your aks resource group&gt; --name &lt;your aks cluster name&gt; --query "servicePrincipalProfile.clientId" --output tsv --subscription &lt;your aks subscription id&gt;)</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>Now get the ID of your Azure Container Registry:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">ACR_ID=$(az acr show --name &lt;your acr name&gt; --resource-group &lt;your acr resource group&gt; --query "id" --output tsv --subscription &lt;your acr subscription id&gt;)

Now grant your AKS cluster SP Reader rights on your ACR:
</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">az role assignment create --assignee $AKS_SP_ID --role Reader --scope $ACR_ID --subscription &lt;your acr subscription id&gt;</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>NOTE:  Trying to pull a non existent tag can result in an authentication error (e.g. myreg.azurecr.io/docker-camunda:latest as opposed to myreg.azurecr.io/docker-camunda:myreg.azurecr.io/docker-camunda:0.0.10)</p>
<p><!-- /wp:paragraph --></p>
