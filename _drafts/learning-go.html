---
layout: post
title: Learning Go
date: 
type: post
parent_id: '0'
published: false
password: ''
status: draft
categories: []
tags: []
meta: {}
author:
  login: bobmclarke915800472
  email: bob.mclarke@gmail.com
  display_name: Bob Clarke
  first_name: ''
  last_name: ''
permalink: "/"
---
<p><!-- wp:paragraph --></p>
<p>I wanted to teach myself GoLang so I thought up a useful tool that I could use in my daily job. I decided to write a tool that would allow me to test connections to common systems such as databases and messaging systems etc. <br />The requirements are as follows:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>Must be able to run inside a Kubernetes cluster (i.e so that I can test services hosted in the cluster that are not exposed outside the cluster) </li>
<li>Must be be able to run in CLI mode or Browser mode</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>Whilst learning Go I also wanted to follow proper testing procedure. I'm follow TDD by writing tests first (sort of) plus I'm making sure testing is automated by implementing an event driven CI pipeline. The CI server I'm using for this is Concourse. <a href="https://concourse-ci.org/">(https://concourse-ci.org/</a>)</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>As a starting point to get me going I'm following an excellent Golang webapp tutorial I found written by a chap called <strong>Soham Kamani</strong>. You can find the tutorial here (<a href="https://www.sohamkamani.com/blog/2017/09/13/how-to-build-a-web-application-in-golang/">https://www.sohamkamani.com/blog/2017/09/13/how-to-build-a-web-application-in-golang/</a>)</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2>Go Testing</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>The <strong>go test</strong> command will look for any files in the same directory  as your source code with a filename of <strong>*_test.go</strong>.  Inside these files, individual tests are defines as functions with the signature <strong>func Test&lt;something&gt; (t *testing.T)</strong><br />For example:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">package main

import (
    "io/ioutil"
    "net/http"
    "net/http/httptest"
    "testing"
)

func TestRouter(t *testing.T) {
    r := getRouter()
    mockServer := httptest.NewServer(r)
    resp, err := http.Get(mockServer.URL + "/hello")

    if err != nil {
        t.Fatal(err)
    }
    if resp.StatusCode != http.StatusOK {
        t.Errorf("Status should be ok, got %d", resp.StatusCode)
    }

    defer resp.Body.Close()
    b, err := ioutil.ReadAll(resp.Body)
    if err != nil {
        t.Fatal(err)
    }

    respString := string(b)
    expected := "Hello World!"

    if respString != expected {
        t.Errorf("Response should be %s, got %s", expected, respString)
    }
}</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:heading --></p>
<h2>Setting up Concourse CI server</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>There a few options for running Concourse which you can find details of here ( <a href="https://concourse-ci.org/">https://concourse-ci.org/</a>). I'm using the Docker Compose option. My docker-compose.yml file is below (you can also download this by running curl -k  https://concourse-ci.org/docker-compose.yml -o docker-compose.yml)</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted"> version: "3"
 services:
   concourse-db:
     image: postgres
     environment:
       - POSTGRES_DB=concourse
       - POSTGRES_PASSWORD=concourse_pass
       - POSTGRES_USER=concourse_user
       - PGDATA=/database
 concourse:
     image: concourse/concourse:4.2.1
     command: quickstart
     privileged: true
     depends_on: [concourse-db]
     ports: ["8080:8080"]
     environment:
       - CONCOURSE_POSTGRES_HOST=concourse-db
       - CONCOURSE_POSTGRES_USER=concourse_user
       - CONCOURSE_POSTGRES_PASSWORD=concourse_pass
       - CONCOURSE_POSTGRES_DATABASE=concourse
       - CONCOURSE_EXTERNAL_URL
       - CONCOURSE_ADD_LOCAL_USER=admin:admin
       - CONCOURSE_MAIN_TEAM_LOCAL_USER=admin</pre>
<p><!-- /wp:preformatted --></p>
<p><!-- wp:paragraph --></p>
<p>Bring the Concourse server up by running docker-compose up -d, start a browser and and then navigate to <a href="http://localhost:8080/">http://localhost:8080/</a>. You should see the concourse home page </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":751} --></p>
<figure class="wp-block-image"><img src="{{ site.baseurl }}/assets/image-2.png?w=800" alt="" class="wp-image-751" /></figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>Concourse is administered using the <strong>fly CLI</strong>, you can download this for your OS by clicking the relevant icon on the bottom left of the Concourse home page.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Now log into concourse using the username and password specified in your docker-compose.yml file (admin/admin in the example above) </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>The first thing you'll need to do is set up a pipeline. This is done via the fly CLI as follows</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:preformatted --></p>
<pre class="wp-block-preformatted">fly login -t local-concourse -c <a href="http://localhost:8080/">http://localhost:8080</a> -u admin -p admin </pre>
<p><!-- /wp:preformatted --></p>
